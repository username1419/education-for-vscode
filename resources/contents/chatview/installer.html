<!DOCTYPE html>
<html>

<head>
    <style>
        select {
            background-color: var(--vscode-dropdown-background);
            border: 1px solid var(--vscode-dropdown-border);
            color: var(--vscode-dropdown-foreground);
            border-radius: 2px;
            height: 1.2;
        }

        select > * {
            background-color: var(--vscode-dropdown-background);
        }

        select > *:hover {
            background-color: var(--vscode-dropdown-background);
            border-color: var(--vscode-dropdown-border);
            color: var(--vscode-dropdown-foreground);
        }

        button {
            background-color: var(--vscode-dropdown-background);
            border: 1px solid var(--vscode-dropdown-border);
            color: var(--vscode-button-foreground);
            border-radius: 2px;
            margin-top: 5px;
        }

        button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .warning > p {
            color: red;
        }
    </style>
</head>

<body>
    <select id="model-selection" onchange="onModelSelect()">
        <option selected disabled>Model</option>
    </select>
    <select id="params-selection" onchange="onParamSelect()">
        <option selected disabled>Size</option>
    </select>
    <div class="warning"></div>
    <button onclick="onInstall()">Install</button>
    <script>
        /** 
         * VS Code WebView API reference for message passing between extension and webview.
         */
        const vscode = acquireVsCodeApi();
        // Get the model selection element
        let modelSelection = document.getElementById('model-selection');
        // Get the warnings container
        const warning = document.getElementsByClassName('warning')[0];
        // Get the parameters selection element
        let paramsSelection = document.getElementById('params-selection');

        /**
         * Event listener for messages sent from the VS Code extension backend.
         */
        window.addEventListener('message', event => {
            const message = event.data;
            console.log(message); // Log the received message for debugging
            
            switch (message.command) {
                case 'createModelOptions': {
                    // Clear all options except placeholder
                    modelSelection.innerHTML = "<option selected disabled>Model</option>";

                    // Validate the message content
                    if (!Array.isArray(message.content)) { return; }

                    // Add each model name as an option in the dropdown
                    message.content.forEach((model) => {
                        if (!typeof model === 'string') { return; }
                        let option = document.createElement('option');
                        option.text = model;
                        modelSelection.appendChild(option);
                    });
                    break;
                }
                case 'createParamsOptions': {
                    // Clear all options except placeholder
                    paramsSelection.innerHTML = '<option selected disabled>Size</option>';

                    // Validate the message content
                    if (!Array.isArray(message.content)) { return; }

                    // Add each parameter size as an option in the dropdown
                    message.content.forEach((modelInfo) => {
                        if (!typeof modelInfo.parameterSize === 'string') { return; }
                        let option = document.createElement('option');
                        option.text = modelInfo.parameterSize;
                        paramsSelection.appendChild(option);
                    });
                    break;
                }
                case 'setWarningMessage': {
                    if (!(typeof message.content === "string")) { return; }
                    // Clear any existing warning messages
                    warning.innerHTML = '';

                    // Add each line of the warning message as a paragraph element
                    // This is done to retain line breaks
                    message.content.split('\n').forEach(v => {
                        const textNode = document.createElement('p');
                        textNode.textContent = v;
                        warning.appendChild(textNode);
                    })
                    break;
                }
                default:
                    // Handle unknown commands
                    console.log(`command not recognized: ${message.command}`);
                    break;
            }
        });

        /**
         * Handles the event when a model is selected from the dropdown.
         * Sends a message to the extension to fetch corresponding parameter options based on the model selected.
         */
        function onModelSelect() {
            vscode.postMessage({
                command: 'setParamsReq',
                model: document.getElementById("model-selection").value
            });
            // Clear parameter size options
            paramsSelection.innerHTML = '<option selected disabled>Size</option>';
            // Remove warning messages
            warning.innerHTML = '';
        }

        /**
         * Handles the event when a parameter size is selected.
         * Sends a message to the extension to validate the selection.
         */
        function onParamSelect() {
            vscode.postMessage({
                command: 'validateParamsReq',
                param: document.getElementById("params-selection").value
            })
        }

        /**
         * Triggered when the user clicks the install button.
         * Sends selected model and parameter data to the extension to install the model.
         */
        function onInstall() {
            const modelSelect = document.getElementById("model-selection");
            const paramSelect = document.getElementById("params-selection");
            // Check if both dropdowns have a valid selection
            if (modelSelect.selectedIndex <= 0 || paramSelect.selectedIndex <= 0) { return; }

            vscode.postMessage({
                command: "installModel",
                model: modelSelect.value,
                params: paramSelect.value
            })
        }
    </script>
</body>

</html>